<script lang="ts">
import { tv, type VariantProps } from 'tailwind-variants'
import type { TreeRootProps, TreeRootEmits } from 'radix-vue'
import type { AppConfig } from '@nuxt/schema'
import _appConfig from '#build/app.config'
import theme from '#build/ui/tree'
import type { PartialString, DynamicSlots, MaybeMultipleModelValue } from '../types/utils'
import { extendDevtoolsMeta } from '../composables/extendDevtoolsMeta'

const appConfig = _appConfig as AppConfig & { ui: { tree: Partial<typeof theme> } }

const tree = tv({ extend: tv(theme), ...(appConfig.ui?.tree || {}) })

type TreeVariants = VariantProps<typeof tree>

export type TreeItem<ValueKey extends string = 'value', LabelKey extends string = 'label'> =
  { [K in ValueKey]?: string } &
  { [L in LabelKey]?: string } &
  {
    icon?: string
    leadingIcon?: string
    trailingIcon?: string
    defaultOpen?: boolean
    disabled?: boolean
    slot?: string
    children?: TreeItem[]
  }

export interface TreeProps<T extends TreeItem<V, L>, M extends boolean = false, V extends string = 'value', L extends string = 'label'> extends Omit<TreeRootProps<T>, 'dir' | 'getKey' | 'multiple' | 'modelValue' | 'defaultValue' | 'items'> {
  /**
   * The element or component this component should render as.
   * @defaultValue 'div'
   */
  as?: any
  color?: TreeVariants['color']
  size?: TreeVariants['size']
  variant?: TreeVariants['variant']
  /**
   * The key used to get the value from the item.
   * @defaultValue 'value'
   */
  valueKey?: V
  /**
   * The key used to get the label from the item.
   * @defaultValue 'label'
   */
  labelKey?: L
  /**
   * The default leading icon displayed on parent nodes.
   */
  parentIcon?: string
  /**
   * The default leading icon displayed on parent nodes.
   */
  parentLeadingIcon?: string
  /**
   * The default trailing icon displayed on parent nodes.
   */
  parentTrailingIcon?: string
  /**
   * The default leading icon displayed on all nodes.
   */
  icon?: string
  /**
   * The default leading icon displayed on all nodes.
   */
  leadingIcon?: string
  /**
   * The default trailing icon displayed on all nodes.
   */
  trailingIcon?: string
  items?: T[]
  /** The controlled value of the Tree. Can be bind as `v-model`. */
  modelValue?: Partial<MaybeMultipleModelValue<T, M>>
  /** The value of the Tree when initially rendered. Use when you do not need to control the state of the Tree. */
  defaultValue?: MaybeMultipleModelValue<T, M>
  /** Whether multiple options can be selected or not. */
  multiple?: M & boolean
  class?: any
  ui?: PartialString<typeof tree.slots>
}

export type TreeEmits<T, M extends boolean = false> = Omit<TreeRootEmits, 'update:modelValue'> & {
  'update:modelValue': [payload: MaybeMultipleModelValue<T, M>]
}

type SlotProps<T> = (props: { item: T, index: number, level: number, hasChildren: boolean, expanded: boolean, selected: boolean }) => any

export type TreeSlots<T extends { slot?: string }> = {
  'item': SlotProps<T>
  'item-leading': SlotProps<T>
  'item-label': SlotProps<T>
  'item-trailing': SlotProps<T>
} & DynamicSlots<T, SlotProps<T>>

extendDevtoolsMeta({ defaultProps: {
  items: [
    {
      label: 'app',
      icon: 'i-lucide-folder',
      defaultOpen: true,
      children: [{
        label: 'composables',
        icon: 'i-lucide-folder',
        defaultOpen: true,
        children: [
          { label: 'useAuth.ts', icon: 'vscode-icons:file-type-typescript' },
          { label: 'useUser.ts', icon: 'vscode-icons:file-type-typescript' }
        ]
      },
      {
        label: 'components',
        icon: 'i-lucide-folder',
        children: [
          {
            label: 'Home',
            icon: 'i-lucide-folder',
            children: [
              { label: 'Card.vue', icon: 'vscode-icons:file-type-vue' },
              { label: 'Button.vue', icon: 'vscode-icons:file-type-vue' }
            ]
          }
        ]
      }]
    },
    { label: 'app.vue', icon: 'vscode-icons:file-type-vue' },
    { label: 'nuxt.config.ts', icon: 'vscode-icons:file-type-nuxt' }
  ]
} })
</script>

<script setup lang="ts" generic="T extends Record<string, any>, M extends boolean = false, V extends string = 'value', L extends string = 'label'">
import { computed } from 'vue'
import { TreeRoot, TreeItem, useForwardPropsEmits } from 'radix-vue'
import { reactiveOmit } from '@vueuse/core'
import { get } from '../utils'
import UIcon from './Icon.vue'

const props = withDefaults(defineProps<TreeProps<T, M, V, L>>(), {
  labelKey: 'label' as never,
  valueKey: 'value' as never
})

const emits = defineEmits<TreeEmits<T, M>>()
const slots = defineSlots<TreeSlots<T>>()

const rootProps = useForwardPropsEmits(reactiveOmit(props, 'class', 'ui'), emits)
const selectedKeys = computed<Set<string>>(() => {
  return Array.isArray(props.modelValue)
    ? new Set(props.modelValue.map((value: TreeItem<V, L>) => getItemKey(value)))
    : new Set([getItemKey(props.modelValue as TreeItem<V, L>)])
})

const ui = computed(() => tree({
  variant: props.variant,
  color: props.color,
  size: props.size
}))

function getItemLabel(item: TreeItem) {
  return get(item, props.labelKey as string)
}

function getItemKey(item?: TreeItem) {
  return get(item, props.valueKey as string) ?? get(item, props.labelKey as string)
}

function getDefaultOpenedItems(item: TreeItem): string[] {
  const currentItem = item.defaultOpen ? item.value ?? item.label : null
  const childItems = item.children?.flatMap(getDefaultOpenedItems) ?? []
  return [currentItem, ...childItems].filter(Boolean) as string[]
}

const defaultOpenedItems = computed(() =>
  props.items?.flatMap(getDefaultOpenedItems)
)

function onItemToggle(item: T, event: Event) {
  if (item.disabled == false) return
  if (item.disabled || props.disabled) event.preventDefault()
}

function onItemSelect(item: T, event: Event) {
  if (item.disabled == false) return
  if (item.disabled || props.disabled) event.preventDefault()
}
</script>

<template>
  <TreeRoot
    v-slot="{ flattenItems }"
    v-bind="rootProps"
    :class="ui.root({ class: [props.class, props.ui?.root] })"
    :get-key="getItemKey"
    :default-expanded="defaultOpenedItems"
  >
    <TreeItem
      v-for="item in flattenItems"
      v-bind="item.bind"
      :key="item._id"
      v-slot="{ isExpanded, isSelected }"
      :class="ui.item({ class: [props.ui?.item] })"
      :style="{ 'padding-left': `${item.level - 0.5}em` }"
      :data-disabled="item.value.disabled !== false && (item.value.disabled || disabled) ? '' : undefined"
      :data-selected="selectedKeys.has(getItemKey(item.value))"
      :aria-label="item.value.label"
      @toggle="onItemToggle(item.value, $event)"
      @select="onItemSelect(item.value, $event)"
    >
      <slot :name="item.value.slot || 'item'" v-bind="{ item: item.value as T, index: item.index, level: item.level, hasChildren: item.hasChildren, expanded: isExpanded, selected: isSelected }">
        <slot :name="item.value.slot ? `${item.value.slot}-leading`: 'item-leading'" v-bind="{ item: item.value, index: item.index, level: item.level, hasChildren: item.hasChildren, expanded: isExpanded, selected: isSelected }">
          <UIcon v-if="item.value.icon || item.value.leadingIcon" :name="item.value.icon ?? item.value.leadingIcon" :class="ui.itemLeadingIcon({ class: props.ui?.itemLeadingIcon })" />
          <UIcon v-else-if="item.hasChildren && (parentIcon || parentLeadingIcon)" :name="(parentIcon ?? parentLeadingIcon) as string" :class="ui.itemLeadingIcon({ class: props.ui?.itemLeadingIcon })" />
          <UIcon v-else-if="icon || leadingIcon" :name="((icon ?? leadingIcon) as string)" :class="ui.itemLeadingIcon({ class: props.ui?.itemLeadingIcon })" />
        </slot>

        <span v-if="getItemLabel(item.value) || !!slots[item.value.slot ? `${item.value.slot}-label`: 'item-label']" :class="ui.itemLabel({ class: props.ui?.itemLabel })">
          <slot :name="item.value.slot ? `${item.value.slot}-label`: 'item-label'" v-bind="{ item: item.value, index: item.index, level: item.level, hasChildren: item.hasChildren, expanded: isExpanded, selected: isSelected }">
            {{ getItemLabel(item.value) }}
          </slot>
        </span>

        <slot :name="item.value.slot ? `${item.value.slot}-trailing`: 'item-trailing'" v-bind="{ item: item.value, index: item.index, level: item.level, hasChildren: item.hasChildren, expanded: isExpanded, selected: isSelected }">
          <UIcon v-if="item.value.trailingIcon" :name="item.value.trailingIcon" :class="ui.itemTrailingIcon({ class: props.ui?.itemTrailingIcon })" />
          <UIcon v-else-if="item.hasChildren && parentTrailingIcon" :name="parentTrailingIcon" :class="ui.itemTrailingIcon({ class: props.ui?.itemTrailingIcon })" />
          <UIcon v-else-if="trailingIcon" :name="trailingIcon" :class="ui.itemTrailingIcon({ class: props.ui?.itemTrailingIcon })" />
        </slot>
      </slot>
    </TreeItem>
  </TreeRoot>
</template>
